# [Audiobooks Green](https://apps.garmin.com/en-EN/apps/0fbb79e9-1b2b-41e6-96a2-32679b484db4)
## О приложении
[Audiobooks Green](https://apps.garmin.com/en-EN/apps/0fbb79e9-1b2b-41e6-96a2-32679b484db4) - приложение для прослушивания аудиокниг для устройств Garmin, НЕОФИЦИАЛЬНЫЙ клиент для вашего собственного сервера [audiobooshelf](https://www.audiobookshelf.org/).

Если у вас есть сервер [audiobooshelf](https://www.audiobookshelf.org/) и часы [Garmin](https://www.garmin.com/en-US/c/wearables-smartwatches/?FILTER_FEATURE_MUSIC=true) с поддержкой музыки, вы можете установить [приложение](https://apps.garmin.com/en-EN/apps/0fbb79e9-1b2b-41e6-96a2-32679b484db4) из [Connct IQ store](https://apps.garmin.com/) и пользоваться им совершенно бесплатно.

## Несколько слов об особенностях реализации сетвого стека устройств Garmin
Устройства Garmin имеют очень ограниченный сетевой стек со множеством ограничений, которые влияют на работу:
1. Поддерживается только секьюрное (https) соединение. Установить обычное http соединение на реальном устройстве (не эмуляторе) невозможно.
1. Все картинки скачиваются через прокси сервер Garmin. Изменить это поведение невозможно.
1. Получать данные (тело ответа) часы могут только в формате json и plain/text. Максимальный размер ответа, который могут обработать часы 8kB. Если размер ответа превысит максимальный, будет возвращен ответ с кодом -402 (минус 402)
1. Если код ответа отличается от 200, нет доступа к телу ответа. Т.е. при получении кода 4xx или 5xx, вы никогда не узнаете в чем проблема
1. ПОЛНОСТЬЮ отсутсвует доступ к входящим заголовкам. А значить отсутсвует возможность получать cookies
1. Крайне ограниченные возможности установки исходящих заголовков
1. Реализованы только методы GET, POST, DELETE, PUT. Такие методы как PATCH или UPDATE отсутсвуют напрочь
1. Телом запроса POST может быть ТОЛЬКО json. Никаких text, xml, binary
1. Скачивать медиафайлы можно только определенных [форматов](https://developer.garmin.com/connect-iq/api-docs/Toybox/Media.html). Если формат не поддерживается, будет ошибка -1005	


## Несколько слов о требованиях особенностях реализации [Audiobooks Green](https://apps.garmin.com/en-EN/apps/0fbb79e9-1b2b-41e6-96a2-32679b484db4)
Из предыдущего пункта напрямую следуют следующее:
1. Ваш сервер должен быть доступен из интернета, иметь доменное имя и валидный сертификат.
2. Для работы приложения ТРЕБУЕТСЯ промежуточный прокси, который пропускает через себя запросы от часов и ответы от сервера. И вот почему:
    - На стеке Garmin принципиально невозможно отправлять на сервер audiobooshelf прогресс рослушивания, так как для этого требуется метод PATCH
    - Но главная боль заключается не в этом. Главная проблема в том, что API архитектура audiobookshelf сделана неоптимально (это мое мнение, которым я не хочу кого-то обидеть). В чем собственно проблема. API audiobokshelf возвращает огромные ОГРОМНЫЕ объемы НЕ НУЖНЫХ в данном контексте данных. Кромет того, в API практически полностью отсутсвует pagination. 
    
        Что я имею в виду. Например я запрашиваю список плейлистов на сервере и, конечно, ожидаю получить json c массивом name и id. На самом деле я получаю json размером почти 3MB (мы еще помним про ограничение Garmin в 8KB?). В этом json содержится не только список всех плейлистов со всеми атрибутами, но и список всех книг из этих плейлистов со всеми атрибутами, а каждая книга содержит список всех медиафайлов со всеми атрибутами. И изменить это поведение никак не возможно. Именно для этого и нужен прокси, который получит этот огромный ответ, отбросит мусор и передаст данные на часы.

Я спрашивал на githab странице audiobookshelf о планах оптимизировать API, но какого-то внятного ответа не получил. В любом случае Audiobooks Green всегда сначала делает прямой запрос к вашему серверу audiobookshels и только при получении ошибки -402 (Serialized response was too large), повторяет запрос через прокси.

Если ваш инстанс audiobookshelf содержит только одну книгу, которая состоит только из одного файла и эта книга добавлена в единственный плейлист, скорее всего, все запросы будут выполнены напрямую, без прокси. За исключением сохранения прогресса, разумеется.

Закгрузка медифайлов всегда происходит напрямую с сервера audiobookshelf минуя прокси сервер.

## Несколько слов о прокси сервере
Для удобства пользователей приложения, я встроил путь к прокси в приложение и совершенно бесплатно предоставляю доступ к своему прокси серверу. Я пользователь [Audiobooks Green](https://apps.garmin.com/en-EN/apps/0fbb79e9-1b2b-41e6-96a2-32679b484db4) и вынужден поддерживать прокси сервер для себя. Нагрузка на него не большая и я вполне могу поделиться его ресурсами с сообществом.

В ответ на это, я получил со стороны комьюнити audiobookshelf некоторый шейминг (вполне справедливый), так как схема работы приложения не прозрачна. Я с этим согласен. Существует угроза безопасности для вашего сервера. Ведь если я злоумышленник, я легко получу полный доступ к вашим серверам. И это истинная правда. 

Особенный упор почему-то делался на наличие прокси, как основного источника угрозы. Почему, я так и не понял. Мне ничто не мешает угнать ваши учетные данные прямо из приложения [Audiobooks Green](https://apps.garmin.com/en-EN/apps/0fbb79e9-1b2b-41e6-96a2-32679b484db4)? 
Также я не понял в чем принципиальная разница между моим приложением и любым другим, установленным из стора или из пакета, который был собран не вами. Кто может гарантировать, что собранный кем-то пакет не содержит бэкдоров?

В любом случае, справедливо утверждение, что если вы пользуетесь программой из [стора](https://apps.garmin.com/en-EN/apps/0fbb79e9-1b2b-41e6-96a2-32679b484db4) и/или моим прокси, ваш инстанс audiobookshelf под угрозой. При желании, я легко сопру ваши учетные данные и буду нахаляву слушать вашего Терри Пратчетта.

Не хотите принимать этот **ужасный риск**, но хотите слушать книги с часов? У меня для вас

## **Отличная новость!!!**
Теперь вы можете самостоятельно проверить ~7000 строк на отсутсвие закладок, самостоятельно собрать приложение и установить его на свои часы.

Но чтобы быть совершенно спокойным, вам придется проделать то же самое с прокси серврером и развернуть его на вашем оборудовании.

## Собираем приложение
### Устанавливаем [Connect IQ SDK](https://developer.garmin.com/connect-iq/overview/)
Инструкции по установке [здесь](https://developer.garmin.com/connect-iq/sdk/) и [здесь](https://developer.garmin.com/connect-iq/connect-iq-basics/getting-started/)
### Копируем код из этого репозитария к вам на машину любым удобным способом
В папке **source/** находим файл Local.mc.example, копируем его с именем Local.mc. И опционально, следуя комментариям в файле, заполняем его своими значениями. 

Вы можете оставить значения по умолчанию. В этом случае не будет доступно получение отладочных сообщений через телеграм, а адрес прокси вам придется ввести в меню во время работы приложения.
### Собираем приложение и копируем его на устройство
Воспользовавшись [инструкцией](https://developer.garmin.com/connect-iq/connect-iq-basics/your-first-app/) с официального сайта.